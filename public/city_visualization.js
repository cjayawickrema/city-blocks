import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// (nestedStructure definition remains the same)
const nestedStructure = {
    "name": "root",
    "fullPath": "",
    "childDirectories": [
      {
        "name": "pricing",
        "fullPath": "pricing",
        "childDirectories": [
          {
            "name": "price-berg",
            "fullPath": "pricing/price-berg",
            "childDirectories": [
              {
                "name": "src",
                "fullPath": "pricing/price-berg/src",
                "childDirectories": [
                  {
                    "name": "main",
                    "fullPath": "pricing/price-berg/src/main",
                    "childDirectories": [
                      {
                        "name": "java",
                        "fullPath": "pricing/price-berg/src/main/java",
                        "childDirectories": [
                          {
                            "name": "com",
                            "fullPath": "pricing/price-berg/src/main/java/com",
                            "childDirectories": [
                              {
                                "name": "cj",
                                "fullPath": "pricing/price-berg/src/main/java/com/cj",
                                "childDirectories": [
                                  {
                                    "name": "datameshpoc",
                                    "fullPath": "pricing/price-berg/src/main/java/com/cj/datameshpoc",
                                    "childDirectories": [
                                      {
                                        "name": "pricing",
                                        "fullPath": "pricing/price-berg/src/main/java/com/cj/datameshpoc/pricing",
                                        "childDirectories": [
                                          {
                                            "name": "priceberg",
                                            "fullPath": "pricing/price-berg/src/main/java/com/cj/datameshpoc/pricing/priceberg",
                                            "childDirectories": [],
                                            "childFiles": [
                                              {
                                                "name": "Main.java",
                                                "fullPath": "pricing/price-berg/src/main/java/com/cj/datameshpoc/pricing/priceberg/Main.java",
                                                "loc": 135,
                                                "count": 10
                                              },
                                              {
                                                "name": "IcebergTableCreation.java",
                                                "fullPath": "pricing/price-berg/src/main/java/com/cj/datameshpoc/pricing/priceberg/IcebergTableCreation.java",
                                                "loc": 140,
                                                "count": 2
                                              }
                                            ],
                                            "loc": 275,
                                            "count": 12
                                          }
                                        ],
                                        "childFiles": [],
                                        "loc": 275,
                                        "count": 12
                                      }
                                    ],
                                    "childFiles": [],
                                    "loc": 275,
                                    "count": 12
                                  }
                                ],
                                "childFiles": [],
                                "loc": 275,
                                "count": 12
                              }
                            ],
                            "childFiles": [],
                            "loc": 275,
                            "count": 12
                          }
                        ],
                        "childFiles": [],
                        "loc": 275,
                        "count": 12
                      },
                      {
                        "name": "resources",
                        "fullPath": "pricing/price-berg/src/main/resources",
                        "childDirectories": [],
                        "childFiles": [
                          {
                            "name": "people.csv",
                            "fullPath": "pricing/price-berg/src/main/resources/people.csv",
                            "loc": 148,
                            "count": 1
                          },
                          {
                            "name": "application.properties",
                            "fullPath": "pricing/price-berg/src/main/resources/application.properties",
                            "loc": 69,
                            "count": 1
                          }
                        ],
                        "loc": 217,
                        "count": 2
                      }
                    ],
                    "childFiles": [],
                    "loc": 492,
                    "count": 14
                  }
                ],
                "childFiles": [],
                "loc": 492,
                "count": 14
              },
              {
                "name": ".idea",
                "fullPath": "pricing/price-berg/.idea",
                "childDirectories": [],
                "childFiles": [
                  {
                    "name": "dbnavigator.xml",
                    "fullPath": "pricing/price-berg/.idea/dbnavigator.xml",
                    "loc": 45,
                    "count": 5
                  },
                  {
                    "name": "gradle.xml",
                    "fullPath": "pricing/price-berg/.idea/gradle.xml",
                    "loc": 185,
                    "count": 2
                  },
                  {
                    "name": "vcs.xml",
                    "fullPath": "pricing/price-berg/.idea/vcs.xml",
                    "loc": 59,
                    "count": 1
                  },
                  {
                    "name": "misc.xml",
                    "fullPath": "pricing/price-berg/.idea/misc.xml",
                    "loc": 197,
                    "count": 1
                  },
                  {
                    "name": ".gitignore",
                    "fullPath": "pricing/price-berg/.idea/.gitignore",
                    "loc": 42,
                    "count": 1
                  }
                ],
                "loc": 528,
                "count": 10
              },
              {
                "name": "gradle",
                "fullPath": "pricing/price-berg/gradle",
                "childDirectories": [
                  {
                    "name": "wrapper",
                    "fullPath": "pricing/price-berg/gradle/wrapper",
                    "childDirectories": [],
                    "childFiles": [
                      {
                        "name": "gradle-wrapper.properties",
                        "fullPath": "pricing/price-berg/gradle/wrapper/gradle-wrapper.properties",
                        "loc": 175,
                        "count": 1
                      },
                      {
                        "name": "gradle-wrapper.jar",
                        "fullPath": "pricing/price-berg/gradle/wrapper/gradle-wrapper.jar",
                        "loc": 84,
                        "count": 1
                      }
                    ],
                    "loc": 259,
                    "count": 2
                  }
                ],
                "childFiles": [],
                "loc": 259,
                "count": 2
              }
            ],
            "childFiles": [
              {
                "name": "build.gradle",
                "fullPath": "pricing/price-berg/build.gradle",
                "loc": 67,
                "count": 4
              },
              {
                "name": ".gitignore",
                "fullPath": "pricing/price-berg/.gitignore",
                "loc": 98,
                "count": 3
              },
              {
                "name": "README.md",
                "fullPath": "pricing/price-berg/README.md",
                "loc": 72,
                "count": 2
              },
              {
                "name": "settings.gradle",
                "fullPath": "pricing/price-berg/settings.gradle",
                "loc": 180,
                "count": 1
              },
              {
                "name": "gradlew.bat",
                "fullPath": "pricing/price-berg/gradlew.bat",
                "loc": 35,
                "count": 1
              },
              {
                "name": "gradlew",
                "fullPath": "pricing/price-berg/gradlew",
                "loc": 108,
                "count": 1
              },
              {
                "name": "docker-compose.yml",
                "fullPath": "pricing/price-berg/docker-compose.yml",
                "loc": 132,
                "count": 1
              }
            ],
            "loc": 1971,
            "count": 39
          },
          {
            "name": "price-service",
            "fullPath": "pricing/price-service",
            "childDirectories": [
              {
                "name": ".idea",
                "fullPath": "pricing/price-service/.idea",
                "childDirectories": [],
                "childFiles": [
                  {
                    "name": "dbnavigator.xml",
                    "fullPath": "pricing/price-service/.idea/dbnavigator.xml",
                    "loc": 192,
                    "count": 5
                  },
                  {
                    "name": "gradle.xml",
                    "fullPath": "pricing/price-service/.idea/gradle.xml",
                    "loc": 88,
                    "count": 2
                  },
                  {
                    "name": "vcs.xml",
                    "fullPath": "pricing/price-service/.idea/vcs.xml",
                    "loc": 52,
                    "count": 1
                  },
                  {
                    "name": "uiDesigner.xml",
                    "fullPath": "pricing/price-service/.idea/uiDesigner.xml",
                    "loc": 193,
                    "count": 1
                  },
                  {
                    "name": "misc.xml",
                    "fullPath": "pricing/price-service/.idea/misc.xml",
                    "loc": 30,
                    "count": 1
                  },
                  {
                    "name": ".gitignore",
                    "fullPath": "pricing/price-service/.idea/.gitignore",
                    "loc": 161,
                    "count": 1
                  }
                ],
                "loc": 716,
                "count": 11
              },
              {
                "name": "src",
                "fullPath": "pricing/price-service/src",
                "childDirectories": [
                  {
                    "name": "main",
                    "fullPath": "pricing/price-service/src/main",
                    "childDirectories": [
                      {
                        "name": "resources",
                        "fullPath": "pricing/price-service/src/main/resources",
                        "childDirectories": [
                          {
                            "name": "db",
                            "fullPath": "pricing/price-service/src/main/resources/db",
                            "childDirectories": [
                              {
                                "name": "migration",
                                "fullPath": "pricing/price-service/src/main/resources/db/migration",
                                "childDirectories": [],
                                "childFiles": [
                                  {
                                    "name": "V2__Insert_Seed_Data.sql",
                                    "fullPath": "pricing/price-service/src/main/resources/db/migration/V2__Insert_Seed_Data.sql",
                                    "loc": 39,
                                    "count": 1
                                  },
                                  {
                                    "name": "V1__Create_product_customer_agreement_tables.sql",
                                    "fullPath": "pricing/price-service/src/main/resources/db/migration/V1__Create_product_customer_agreement_tables.sql",
                                    "loc": 115,
                                    "count": 1
                                  }
                                ],
                                "loc": 154,
                                "count": 2
                              }
                            ],
                            "childFiles": [],
                            "loc": 154,
                            "count": 2
                          }
                        ],
                        "childFiles": [
                          {
                            "name": "application.properties",
                            "fullPath": "pricing/price-service/src/main/resources/application.properties",
                            "loc": 153,
                            "count": 3
                          }
                        ],
                        "loc": 307,
                        "count": 5
                      },
                      {
                        "name": "java",
                        "fullPath": "pricing/price-service/src/main/java",
                        "childDirectories": [
                          {
                            "name": "org",
                            "fullPath": "pricing/price-service/src/main/java/org",
                            "childDirectories": [
                              {
                                "name": "example",
                                "fullPath": "pricing/price-service/src/main/java/org/example",
                                "childDirectories": [],
                                "childFiles": [
                                  {
                                    "name": "Main.java",
                                    "fullPath": "pricing/price-service/src/main/java/org/example/Main.java",
                                    "loc": 122,
                                    "count": 2
                                  }
                                ],
                                "loc": 122,
                                "count": 2
                              }
                            ],
                            "childFiles": [],
                            "loc": 122,
                            "count": 2
                          },
                          {
                            "name": "com",
                            "fullPath": "pricing/price-service/src/main/java/com",
                            "childDirectories": [
                              {
                                "name": "cj",
                                "fullPath": "pricing/price-service/src/main/java/com/cj",
                                "childDirectories": [
                                  {
                                    "name": "datameshpoc",
                                    "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc",
                                    "childDirectories": [
                                      {
                                        "name": "pricing",
                                        "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing",
                                        "childDirectories": [
                                          {
                                            "name": "api",
                                            "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api",
                                            "childDirectories": [
                                              {
                                                "name": "service",
                                                "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/service",
                                                "childDirectories": [],
                                                "childFiles": [
                                                  {
                                                    "name": "PriceService.java",
                                                    "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/service/PriceService.java",
                                                    "loc": 56,
                                                    "count": 2
                                                  }
                                                ],
                                                "loc": 56,
                                                "count": 2
                                              },
                                              {
                                                "name": "model",
                                                "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/model",
                                                "childDirectories": [],
                                                "childFiles": [
                                                  {
                                                    "name": "Product.java",
                                                    "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/model/Product.java",
                                                    "loc": 178,
                                                    "count": 2
                                                  },
                                                  {
                                                    "name": "PriceRequest.java",
                                                    "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/model/PriceRequest.java",
                                                    "loc": 33,
                                                    "count": 2
                                                  }
                                                ],
                                                "loc": 211,
                                                "count": 4
                                              },
                                              {
                                                "name": "controller",
                                                "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/controller",
                                                "childDirectories": [],
                                                "childFiles": [
                                                  {
                                                    "name": "PriceController.java",
                                                    "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/controller/PriceController.java",
                                                    "loc": 167,
                                                    "count": 2
                                                  }
                                                ],
                                                "loc": 167,
                                                "count": 2
                                              },
                                              {
                                                "name": "repository",
                                                "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/repository",
                                                "childDirectories": [],
                                                "childFiles": [
                                                  {
                                                    "name": "PriceDAO.java",
                                                    "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/repository/PriceDAO.java",
                                                    "loc": 61,
                                                    "count": 1
                                                  }
                                                ],
                                                "loc": 61,
                                                "count": 1
                                              }
                                            ],
                                            "childFiles": [
                                              {
                                                "name": "Main.java",
                                                "fullPath": "pricing/price-service/src/main/java/com/cj/datameshpoc/pricing/api/Main.java",
                                                "loc": 199,
                                                "count": 1
                                              }
                                            ],
                                            "loc": 694,
                                            "count": 10
                                          }
                                        ],
                                        "childFiles": [],
                                        "loc": 694,
                                        "count": 10
                                      }
                                    ],
                                    "childFiles": [],
                                    "loc": 694,
                                    "count": 10
                                  }
                                ],
                                "childFiles": [],
                                "loc": 694,
                                "count": 10
                              }
                            ],
                            "childFiles": [],
                            "loc": 694,
                            "count": 10
                          }
                        ],
                        "childFiles": [],
                        "loc": 816,
                        "count": 12
                      }
                    ],
                    "childFiles": [],
                    "loc": 1123,
                    "count": 17
                  }
                ],
                "childFiles": [],
                "loc": 1123,
                "count": 17
              },
              {
                "name": "gradle",
                "fullPath": "pricing/price-service/gradle",
                "childDirectories": [
                  {
                    "name": "wrapper",
                    "fullPath": "pricing/price-service/gradle/wrapper",
                    "childDirectories": [],
                    "childFiles": [
                      {
                        "name": "gradle-wrapper.properties",
                        "fullPath": "pricing/price-service/gradle/wrapper/gradle-wrapper.properties",
                        "loc": 81,
                        "count": 1
                      },
                      {
                        "name": "gradle-wrapper.jar",
                        "fullPath": "pricing/price-service/gradle/wrapper/gradle-wrapper.jar",
                        "loc": 127,
                        "count": 1
                      }
                    ],
                    "loc": 208,
                    "count": 2
                  }
                ],
                "childFiles": [],
                "loc": 208,
                "count": 2
              }
            ],
            "childFiles": [
              {
                "name": "README.md",
                "fullPath": "pricing/price-service/README.md",
                "loc": 78,
                "count": 5
              },
              {
                "name": "build.gradle",
                "fullPath": "pricing/price-service/build.gradle",
                "loc": 110,
                "count": 4
              },
              {
                "name": "settings.gradle",
                "fullPath": "pricing/price-service/settings.gradle",
                "loc": 48,
                "count": 1
              },
              {
                "name": "gradlew.bat",
                "fullPath": "pricing/price-service/gradlew.bat",
                "loc": 103,
                "count": 1
              },
              {
                "name": "gradlew",
                "fullPath": "pricing/price-service/gradlew",
                "loc": 170,
                "count": 1
              },
              {
                "name": ".gitignore",
                "fullPath": "pricing/price-service/.gitignore",
                "loc": 95,
                "count": 1
              }
            ],
            "loc": 2651,
            "count": 43
          }
        ],
        "childFiles": [],
        "loc": 4622,
        "count": 82
      },
      {
        "name": ".idea",
        "fullPath": ".idea",
        "childDirectories": [],
        "childFiles": [
          {
            "name": "vcs.xml",
            "fullPath": ".idea/vcs.xml",
            "loc": 64,
            "count": 1
          },
          {
            "name": "modules.xml",
            "fullPath": ".idea/modules.xml",
            "loc": 189,
            "count": 1
          },
          {
            "name": "misc.xml",
            "fullPath": ".idea/misc.xml",
            "loc": 31,
            "count": 1
          },
          {
            "name": "dbnavigator.xml",
            "fullPath": ".idea/dbnavigator.xml",
            "loc": 157,
            "count": 1
          },
          {
            "name": ".name",
            "fullPath": ".idea/.name",
            "loc": 91,
            "count": 1
          },
          {
            "name": ".gitignore",
            "fullPath": ".idea/.gitignore",
            "loc": 144,
            "count": 1
          }
        ],
        "loc": 676,
        "count": 6
      }
    ],
    "childFiles": [
      {
        "name": "data-mesh-poc.iml",
        "fullPath": "data-mesh-poc.iml",
        "loc": 118,
        "count": 1
      },
      {
        "name": ".gitignore",
        "fullPath": ".gitignore",
        "loc": 76,
        "count": 1
      },
      {
        "name": ".DS_Store",
        "fullPath": ".DS_Store",
        "loc": 129,
        "count": 1
      }
    ],
    "loc": 5621,
    "count": 91
  };


const FOUNDATION_HEIGHT = 5;
const PADDING = 20;
const ITEM_SPACING = 10;
const HEIGHT_FACTOR = 20;
const MIN_VISIBLE_BUILDING_HEIGHT = 0.5;
const MIN_LAYOUT_DIMENSION = 5; // Min dimension for layout purposes (for 0-loc files)
const MIN_RENDER_DIMENSION = 2.5; // Min actual render dimension for 0-loc files


const BASE_FOUNDATION_COLOR = new THREE.Color(0xdddddd);
const FOUNDATION_DARKEN_PER_LEVEL = 0.05;

const GROUND_MATERIAL = new THREE.MeshLambertMaterial({ color: 0x50c878 });

const PACKING_ASPECT_RATIO_TARGET = 2.0; // Lower numbers try harder to make rows squarer

let scene, camera, renderer, controls;
let raycaster, mouse, tooltipElement, intersectedObject = null;
const pickableObjects = [];

function collectAllFiles(node, fileList) {
    if (!node) return;
    if (node.childFiles && Array.isArray(node.childFiles)) {
        node.childFiles.forEach(file => {
            fileList.push(file);
        });
    }
    if (node.childDirectories && Array.isArray(node.childDirectories)) {
        node.childDirectories.forEach(dir => {
            collectAllFiles(dir, fileList);
        });
    }
}

function preprocessFileData(rootNode) {
    const allFiles = [];
    collectAllFiles(rootNode, allFiles);
    let largestCountValue = 0;
    if (allFiles.length > 0) {
        largestCountValue = allFiles.reduce((max, file) => Math.max(max, file.count || 0), 0);
    }
    const effectiveLargestCount = largestCountValue === 0 ? 1 : largestCountValue;
    allFiles.forEach(file => {
        file.heat = (file.count || 0) / effectiveLargestCount;
    });
}

function getHeatColor(heatInput) {
    const heat = (typeof heatInput === 'number' && !isNaN(heatInput)) ? heatInput : 0;
    const color = new THREE.Color();
    const blue = new THREE.Color(0x0000ff);
    const yellow = new THREE.Color(0xffff00);
    const red = new THREE.Color(0xff0000);
    if (heat <= 0) return blue;
    if (heat >= 1) return red;
    if (heat <= 0.5) {
        color.lerpColors(blue, yellow, heat * 2);
    } else {
        color.lerpColors(yellow, red, (heat - 0.5) * 2);
    }
    return color;
}

function calculateLayout(node) {
    if (!node) return { width: 0, depth: 0 };
    const isDirectoryNode = !!(node.childFiles || node.childDirectories);
    node.isDirectory = isDirectoryNode;

    if (isDirectoryNode) {
        const childrenToLayout = [...(node.childFiles || []), ...(node.childDirectories || [])];
        childrenToLayout.forEach(child => {
            calculateLayout(child); // Recursive call to ensure children dimensions are calculated
            if (!child.isDirectory) { // It's a File, ensure buildingHeight is set
                 child.buildingHeight = Math.max((child.count || 0) * HEIGHT_FACTOR, MIN_VISIBLE_BUILDING_HEIGHT);
            }
        });

        // Sort children before packing, e.g., by decreasing width (heuristic)
        childrenToLayout.sort((a, b) => {
            const widthA = a.isDirectory ? a.calculatedOuterWidth : (a.loc > 0 ? a.loc : MIN_LAYOUT_DIMENSION);
            const widthB = b.isDirectory ? b.calculatedOuterWidth : (b.loc > 0 ? b.loc : MIN_LAYOUT_DIMENSION);
            return widthB - widthA;
        });

        let rows = [];
        let currentRowItems = [];
        let currentRowWidth = 0;
        let currentRowMaxDepth = 0;

        childrenToLayout.forEach(child => {
            const childW = child.isDirectory ? child.calculatedOuterWidth : (child.loc > 0 ? child.loc : MIN_LAYOUT_DIMENSION);
            const childD = child.isDirectory ? child.calculatedOuterDepth : (child.loc > 0 ? child.loc : MIN_LAYOUT_DIMENSION);

            if (currentRowItems.length === 0) {
                currentRowItems.push({ node: child, w: childW, d: childD });
                currentRowWidth = childW;
                currentRowMaxDepth = childD;
            } else {
                const potentialRowWidth = currentRowWidth + ITEM_SPACING + childW;
                const potentialMaxDepth = Math.max(currentRowMaxDepth, childD);
                
                // Heuristic: if adding the item makes the row too elongated, or it's the first item (always add)
                if (potentialRowWidth / potentialMaxDepth > PACKING_ASPECT_RATIO_TARGET && currentRowItems.length > 0 && currentRowItems.length < 5) { // Add up to 5 items before aggressively making new row
                    rows.push({ items: currentRowItems, width: currentRowWidth, maxDepth: currentRowMaxDepth });
                    currentRowItems = [{ node: child, w: childW, d: childD }];
                    currentRowWidth = childW;
                    currentRowMaxDepth = childD;
                } else {
                    currentRowItems.push({ node: child, w: childW, d: childD });
                    currentRowWidth = potentialRowWidth; // Recalculate actual row width
                    currentRowMaxDepth = potentialMaxDepth;
                }
            }
        });
        if (currentRowItems.length > 0) {
            // Recalculate width for the final row properly
            let finalRowW = 0;
            currentRowItems.forEach((item, index) => {
                finalRowW += item.w;
                if (index < currentRowItems.length -1) finalRowW += ITEM_SPACING;
            });
            rows.push({ items: currentRowItems, width: finalRowW, maxDepth: currentRowMaxDepth });
        }
        
        node.innerWidth = 0;
        let currentZOffsetForRowBase = 0;
        rows.forEach(row => {
            let currentXOffsetInRow = 0;
            row.items.forEach(item => {
                item.node.prelimX = currentXOffsetInRow + item.w / 2;
                item.node.prelimZ = currentZOffsetForRowBase + item.d / 2;
                currentXOffsetInRow += item.w + ITEM_SPACING;
            });
            node.innerWidth = Math.max(node.innerWidth, row.width);
            currentZOffsetForRowBase += row.maxDepth + ITEM_SPACING;
        });
        node.innerDepth = (rows.length > 0) ? currentZOffsetForRowBase - ITEM_SPACING : 0;

        childrenToLayout.forEach(childNode => { // Or iterate through items in rows
            childNode.renderOffsetX = (childNode.prelimX || 0) - node.innerWidth / 2;
            childNode.renderOffsetZ = (childNode.prelimZ || 0) - node.innerDepth / 2;
        });
        
        node.calculatedOuterWidth = node.innerWidth + 2 * PADDING;
        node.calculatedOuterDepth = node.innerDepth + 2 * PADDING;
        node.foundationHeight = FOUNDATION_HEIGHT;
        return { width: node.calculatedOuterWidth, depth: node.calculatedOuterDepth };

    } else { // It's a File
        if (node.buildingHeight === undefined) {
             node.buildingHeight = Math.max((node.count || 0) * HEIGHT_FACTOR, MIN_VISIBLE_BUILDING_HEIGHT);
        }
        const w = node.loc > 0 ? node.loc : MIN_LAYOUT_DIMENSION;
        const d = node.loc > 0 ? node.loc : MIN_LAYOUT_DIMENSION;
        return { width: w, depth: d };
    }
}

function createThreeObjects(node, parentThreeGroup, baseCenterPosition, depthLevel) {
    if (!node) return;

    if (node.isDirectory) {
        const geoWidth = Math.max(node.calculatedOuterWidth, 0.1);
        const geoHeight = Math.max(node.foundationHeight, 0.1);
        const geoDepth = Math.max(node.calculatedOuterDepth, 0.1);
        const foundationGeo = new THREE.BoxGeometry(geoWidth, geoHeight, geoDepth);
        const colorScaleFactor = Math.max(0, 1.0 - (depthLevel * FOUNDATION_DARKEN_PER_LEVEL));
        const foundationColor = new THREE.Color(
            BASE_FOUNDATION_COLOR.r * colorScaleFactor,
            BASE_FOUNDATION_COLOR.g * colorScaleFactor,
            BASE_FOUNDATION_COLOR.b * colorScaleFactor
        );
        const currentFoundationMaterial = new THREE.MeshLambertMaterial({ color: foundationColor });
        const foundationMesh = new THREE.Mesh(foundationGeo, currentFoundationMaterial);
        foundationMesh.position.set(baseCenterPosition.x, baseCenterPosition.y + node.foundationHeight / 2, baseCenterPosition.z);
        foundationMesh.userData = { type: 'Directory', nodeData: node, depthLevel: depthLevel };
        parentThreeGroup.add(foundationMesh);
        pickableObjects.push(foundationMesh);
        const childrenBaseY = baseCenterPosition.y + node.foundationHeight;
        const childrenOriginX = baseCenterPosition.x;
        const childrenOriginZ = baseCenterPosition.z;
        
        // Use childrenToLayout from node if it was stored, or iterate directly
        // The renderOffsetX/Z are on the child nodes themselves
        const childrenToDraw = [...(node.childFiles || []), ...(node.childDirectories || [])];
        childrenToDraw.forEach(childNode => {
            if(childNode.renderOffsetX === undefined || childNode.renderOffsetZ === undefined) {
                // This can happen if a child was not part of the layout process, e.g. an empty childrenToLayout array for parent
                // Or if childNode somehow isn't one of the items processed in calculateLayout's packing.
                // Default to 0,0 if undefined to prevent NaN errors, though ideally this shouldn't be hit.
                // console.warn("Child node missing renderOffset:", childNode.name);
                childNode.renderOffsetX = 0;
                childNode.renderOffsetZ = 0;
            }
            const childCenterPos = new THREE.Vector3(childrenOriginX + childNode.renderOffsetX, childrenBaseY, childrenOriginZ + childNode.renderOffsetZ);
            createThreeObjects(childNode, parentThreeGroup, childCenterPos, depthLevel + 1);
        });

    } else { // It's a File
        const buildingWidth = node.loc > 0 ? node.loc : MIN_RENDER_DIMENSION;
        const buildingDepth = node.loc > 0 ? node.loc : MIN_RENDER_DIMENSION;
        const buildingHeight = node.buildingHeight;
        const buildingColor = getHeatColor(node.heat);
        const buildingMaterial = new THREE.MeshLambertMaterial({ color: buildingColor });
        const buildingGeo = new THREE.BoxGeometry(
            Math.max(buildingWidth, 0.1),
            Math.max(buildingHeight, 0.1),
            Math.max(buildingDepth, 0.1)
        );
        const buildingMesh = new THREE.Mesh(buildingGeo, buildingMaterial);
        buildingMesh.position.set(baseCenterPosition.x, baseCenterPosition.y + buildingHeight / 2, baseCenterPosition.z);
        buildingMesh.userData = { type: 'File', nodeData: node };
        parentThreeGroup.add(buildingMesh);
        pickableObjects.push(buildingMesh);
    }
}

function onMouseMove(event) {
    if (!mouse || !tooltipElement) return;
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
    tooltipElement.style.left = (event.clientX + 15) + 'px';
    tooltipElement.style.top = (event.clientY + 15) + 'px';
}

function updateTooltip() {
    if(!raycaster || !mouse || !camera || !tooltipElement) return;
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(pickableObjects, false);
    if (intersects.length > 0) {
        const firstIntersected = intersects[0].object;
        if (firstIntersected !== intersectedObject) {
            intersectedObject = firstIntersected;
            if (intersectedObject.userData && intersectedObject.userData.nodeData) {
                const nodeData = intersectedObject.userData.nodeData;
                const type = intersectedObject.userData.type;
                let locText = nodeData.loc !== undefined ? `${nodeData.loc} Lines` : 'N/A Lines';
                let countText = (nodeData.count || 0) !== undefined ? `${nodeData.count || 0} Commits` : 'N/A Commits';
                let fullPathText = nodeData.fullPath;
                if (type === 'Directory' && !fullPathText && nodeData.name === "root") {
                    fullPathText = "/ (Project Root)";
                } else if (!fullPathText && nodeData.name) {
                    fullPathText = nodeData.name;
                } else if (!fullPathText && !nodeData.name) {
                    fullPathText = "N/A";
                }
                let tooltipHTML = `
                    <strong>${nodeData.name || 'Unnamed'}</strong>
                    <ul>
                        <li>${fullPathText}</li>
                        <li>${locText}</li>
                        <li>${countText}</li>
                        ${type === 'File' && nodeData.heat !== undefined ? `<li>Heat: ${nodeData.heat.toFixed(2)}</li>` : ''}
                        ${type === 'Directory' && intersectedObject.userData.depthLevel !== undefined ? `<li>Depth: ${intersectedObject.userData.depthLevel}</li>` : ''}
                    </ul>
                `;
                tooltipElement.style.display = 'block';
                tooltipElement.innerHTML = tooltipHTML;
            } else {
                tooltipElement.style.display = 'none';
                intersectedObject = null;
            }
        }
    } else {
        if (intersectedObject !== null) {
            tooltipElement.style.display = 'none';
            intersectedObject = null;
        }
    }
}

function init() {
    preprocessFileData(nestedStructure);
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    const aspect = window.innerWidth / window.innerHeight;
    camera = new THREE.PerspectiveCamera(75, aspect, 1, 50000);
    const canvas = document.getElementById('canvas');
    renderer = new THREE.WebGLRenderer({ antialias: true, canvas: canvas });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 1;
    controls.maxDistance = 20000;
    controls.maxPolarAngle = Math.PI / 2 - 0.01;
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
    directionalLight.position.set(150, 250, 200);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 2048;
    directionalLight.shadow.mapSize.height = 2048;
    directionalLight.shadow.camera.near = 10;
    directionalLight.shadow.camera.far = 1000;
    directionalLight.shadow.camera.left = -500;
    directionalLight.shadow.camera.right = 500;
    directionalLight.shadow.camera.top = 500;
    directionalLight.shadow.camera.bottom = -500;
    scene.add(directionalLight);
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2(-1000,-1000);
    tooltipElement = document.getElementById('tooltip');
    window.addEventListener('mousemove', onMouseMove, false);
    const overallLayout = calculateLayout(nestedStructure);
    const groundSize = Math.max(overallLayout.width || 100, overallLayout.depth || 100, 200) * 2.0;
    const groundGeo = new THREE.PlaneGeometry(groundSize, groundSize);
    const groundMesh = new THREE.Mesh(groundGeo, GROUND_MATERIAL.clone());
    groundMesh.rotation.x = -Math.PI / 2;
    groundMesh.position.y = -0.1;
    groundMesh.receiveShadow = true;
    scene.add(groundMesh);
    if (nestedStructure.isDirectory) {
         createThreeObjects(nestedStructure, scene, new THREE.Vector3(0, 0, 0), 0);
    } else if (nestedStructure.loc !== undefined && nestedStructure.count !== undefined) {
         createThreeObjects(nestedStructure, scene, new THREE.Vector3(0,0,0), 0);
    } else {
         (nestedStructure.layoutChildrenData || []).forEach(itemData => {
             const childNode = itemData.node;
             const childCenterPos = new THREE.Vector3(
                 childNode.renderOffsetX || 0,
                 0,
                 childNode.renderOffsetZ || 0
             );
             createThreeObjects(childNode, scene, childCenterPos, 0);
         });
    }
    if (overallLayout && overallLayout.width !== undefined && overallLayout.depth !== undefined && overallLayout.width > 0 && overallLayout.depth > 0) {
        camera.position.set(overallLayout.width * 0.75, Math.max(overallLayout.width, overallLayout.depth) * 0.6, overallLayout.depth * 0.75);
        controls.target.set(0, Math.min(overallLayout.width, overallLayout.depth) / 8 , 0); // Lower target slightly
    } else {
        camera.position.set(100, 150, 200);
        controls.target.set(0, 0, 0);
    }
    camera.lookAt(controls.target);
    controls.update();
    window.addEventListener('resize', onWindowResize, false);
    animate();
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    updateTooltip();
    renderer.render(scene, camera);
}

init();